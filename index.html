<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Editor - Soft UI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.2/ace.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .editor-container {
            height: 100%;
            width: 100%;
        }

        /* --- Custom Scrollbar & UI Polish --- */
        /* Works on Chrome, Edge, and Safari */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* stone-300 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af; /* stone-400 */
        }
        
        /* ACE Editor Specific Scrollbar */
        .ace_scrollbar { -webkit-appearance: none; }

        /* Console Readability Enhancement */
        #console-output > div:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.03);
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 h-screen flex flex-col antialiased overflow-hidden" 
      x-data="{ 
          isOutputVisible: true, 
          activeView: 'editor',
          isVersionsPanelOpen: false,
          versions: [],

          // Helper to format dates nicely in the versions panel
          formatDate(timestamp) {
              return new Date(timestamp).toLocaleString(undefined, { 
                  dateStyle: 'medium', 
                  timeStyle: 'short' 
              });
          },

          // Opens the version history panel and fetches all saved versions
          async openVersionsPanel() {
              try {
                  const versionList = await codeDB.getVersions();
                  this.versions = versionList;
                  this.isVersionsPanelOpen = true;
              } catch (err) {
                  console.error('Failed to fetch versions:', err);
                  alert('Could not load version history.');
              }
          },
          
          // Saves the current state of all editors as a new version
          async saveCurrentVersion() {
              const head = window.headEditor.getValue();
              const html = window.htmlEditor.getValue();
              const script = window.scriptEditor.getValue();
              try {
                  await codeDB.saveVersion(head, html, script);
                  // Refresh the list to show the new version at the top
                  this.versions = await codeDB.getVersions();
              } catch(err) {
                  console.error('Failed to save version:', err);
                  alert('Could not save the current version.');
              }
          },
          
          // Restores the code from a selected version ID
          async restoreSelectedVersion(id) {
              if (!confirm('Are you sure you want to restore this version? Your current work in the editors will be replaced.')) {
                  return;
              }
              try {
                  const version = await codeDB.getVersionById(id);
                  if (version) {
                      window.headEditor.setValue(version.head || '', 1);
                      window.htmlEditor.setValue(version.html || '', 1);
                      window.scriptEditor.setValue(version.script || '', 1);
                      this.isVersionsPanelOpen = false;
                      runCode(); // Update the preview with the restored code
                  } else {
                      alert('Version not found.');
                  }
              } catch (err) {
                  console.error('Failed to restore version:', err);
                  alert('An error occurred while restoring the version.');
              }
          },
          
          // Deletes a version by its ID
          async deleteSelectedVersion(id) {
              if (!confirm('Are you sure you want to permanently delete this version?')) {
                  return;
              }
              try {
                  await codeDB.deleteVersion(id);
                  // Refresh the list to remove the deleted version
                  this.versions = await codeDB.getVersions();
              } catch (err) {
                  console.error('Failed to delete version:', err);
                  alert('Could not delete the version.');
              }
          },

          init() { 
              this.$watch('isOutputVisible', () => this.$nextTick(() => { 
                  if(window.headEditor) window.headEditor.resize();
                  if(window.htmlEditor) window.htmlEditor.resize(); 
                  if(window.scriptEditor) window.scriptEditor.resize(); 
              })) 
          } 
      }">

    <div class="flex-grow flex flex-col md:flex-row h-[calc(100%-3rem)] overflow-hidden p-3 gap-3">
        
        <!-- Editor Panel -->
        <div class="w-full flex flex-col h-full transition-all duration-300 bg-white rounded-xl shadow-sm overflow-hidden border border-stone-200"
             :class="{ 
                'hidden md:flex': activeView === 'output',
                'md:w-1/2': isOutputVisible, 
                'md:w-full': !isOutputVisible 
             }"
             x-data="{ 
                tab: 'html',
                copyStatus: 'Copy',

                copyTabCode() {
                    let editor;
                    if (this.tab === 'head') editor = window.headEditor;
                    else if (this.tab === 'html') editor = window.htmlEditor;
                    else editor = window.scriptEditor;
                    navigator.clipboard.writeText(editor.getValue()).then(() => {
                        this.copyStatus = `Copied ${this.tab.charAt(0).toUpperCase() + this.tab.slice(1)}!`;
                        setTimeout(() => this.copyStatus = 'Copy', 2000);
                    });
                 },
                copyAllCode() {
                    navigator.clipboard.writeText(getFullSource()).then(() => {
                        this.copyStatus = 'Copied All!';
                        setTimeout(() => this.copyStatus = 'Copy', 2000);
                    });
                },

                async pasteIntoTabCode() {
                     try {
                        const text = await navigator.clipboard.readText();
                        let editor;
                        if (this.tab === 'head') editor = window.headEditor;
                        else if (this.tab === 'html') editor = window.htmlEditor;
                        else editor = window.scriptEditor;
                        editor.setValue(text, 1);
                     } catch (err) {
                        console.error('Failed to read clipboard contents: ', err);
                        alert('Could not paste from clipboard. Please ensure you have granted the necessary permissions.');
                     }
                },
                async pasteAllAndParse() {
                    try {
                        const text = await navigator.clipboard.readText();
                        if (!text.trim()) {
                            alert('Clipboard is empty.');
                            return;
                        }
                        if (!window.parseAndLoadHtml(text)) { }
                    } catch (err) {
                        console.error('Failed to read clipboard contents: ', err);
                        alert('Could not read from clipboard. Please ensure you have granted the necessary permissions.');
                    }
                },
                clearCode() { 
                    if (confirm('Are you sure you want to clear all editors? This cannot be undone.')) {
                        if (window.headEditor) window.headEditor.setValue('', -1);
                        if (window.htmlEditor) window.htmlEditor.setValue('', -1);
                        if (window.scriptEditor) window.scriptEditor.setValue('', -1);
                    }
                }
             }">
            <div class="flex justify-between items-center bg-stone-50 p-3 border-b border-stone-200 flex-shrink-0 flex-wrap gap-x-4 gap-y-2">
                <div class="flex items-center space-x-2">
                    <button @click="tab = 'head'" :class="{ 'bg-indigo-100 text-indigo-700 font-semibold border-indigo-500': tab === 'head', 'text-stone-500 hover:bg-stone-200 hover:text-stone-700 border-transparent': tab !== 'head' }" class="px-4 py-1.5 rounded-t-lg text-sm transition-all border-b-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">Head</button>
                    <button @click="tab = 'html'" :class="{ 'bg-indigo-100 text-indigo-700 font-semibold border-indigo-500': tab === 'html', 'text-stone-500 hover:bg-stone-200 hover:text-stone-700 border-transparent': tab !== 'html' }" class="px-4 py-1.5 rounded-t-lg text-sm transition-all border-b-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">HTML</button>
                    <button @click="tab = 'script'" :class="{ 'bg-indigo-100 text-indigo-700 font-semibold border-indigo-500': tab === 'script', 'text-stone-500 hover:bg-stone-200 hover:text-stone-700 border-transparent': tab !== 'script' }" class="px-4 py-1.5 rounded-t-lg text-sm transition-all border-b-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">Script</button>
                </div>
                 <div class="flex items-center space-x-2 md:space-x-4">
                    <button @click="document.getElementById('file-importer').click()" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="Import from HTML file">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span class="hidden md:inline">Import</span>
                    </button>
                    <input type="file" id="file-importer" class="hidden" accept=".html" onchange="importFromFile(event)">
                    
                    <!-- NEW: History Button -->
                    <button @click="openVersionsPanel()" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="View code history">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="hidden md:inline">History</span>
                    </button>

                    <div x-data="{ open: false }" class="relative" @keydown.escape.prevent.stop="open = false" @focusout.window="! $el.contains($event.target) && (open = false)">
                        <button @click="open = !open" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="Paste code from clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            <span class="hidden md:inline">Paste</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div x-show="open" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 py-1 z-10" x-cloak>
                            <a href="#" @click.prevent="pasteIntoTabCode(); open = false" class="block px-4 py-2 text-sm text-stone-700 hover:bg-stone-100">Paste into <strong class="capitalize" x-text="tab"></strong></a>
                            <a href="#" @click.prevent="pasteAllAndParse(); open = false" class="block px-4 py-2 text-sm text-stone-700 hover:bg-stone-100">Paste & Parse All</a>
                        </div>
                    </div>

                    <button @click="exportToFile()" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="Export as HTML file">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span class="hidden md:inline">Export</span>
                    </button>
                    <span class="border-l border-stone-200 h-5 hidden md:block"></span>

                    <div x-data="{ open: false }" class="relative" @keydown.escape.prevent.stop="open = false" @focusout.window="! $el.contains($event.target) && (open = false)">
                        <button @click="open = !open" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="Copy code to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            <span x-text="copyStatus" class="hidden md:inline min-w-[60px] text-left"></span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                         <div x-show="open" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 py-1 z-10" x-cloak>
                            <a href="#" @click.prevent="copyTabCode(); open = false" class="block px-4 py-2 text-sm text-stone-700 hover:bg-stone-100">Copy <strong class="capitalize" x-text="tab"></strong> Only</a>
                            <a href="#" @click.prevent="copyAllCode(); open = false" class="block px-4 py-2 text-sm text-stone-700 hover:bg-stone-100">Copy All Code</a>
                        </div>
                    </div>

                     <button @click="clearCode()" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="Clear all code">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        <span class="hidden md:inline">Clear All</span>
                    </button>
                </div>
            </div>
            
            <div class="flex-grow overflow-auto">
                <div x-show="tab === 'head'" x-cloak class="h-full"><div id="head-editor" class="editor-container"></div></div>
                <div x-show="tab === 'html'" class="h-full"><div id="html-editor" class="editor-container"></div></div>
                <div x-show="tab === 'script'" x-cloak class="h-full"><div id="script-editor" class="editor-container"></div></div>
            </div>

            <div class="hidden md:flex justify-between items-center p-3 border-t border-stone-200 flex-shrink-0">
                <button x-show="!isOutputVisible" @click="isOutputVisible = true" title="Show Output" class="text-stone-400 hover:text-indigo-600 transition-colors rounded-md focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.27 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                </button>
                <span class="flex-grow"></span> <!-- Spacer -->
                <button id="run-button-desktop" @click="runCode(); activeView = 'output'" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg flex items-center space-x-2 transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <span>Run</span>
                </button>
            </div>
        </div>
        
        <!-- Output Panel -->
        <div class="w-full md:w-1/2 flex flex-col h-full bg-white rounded-xl shadow-sm overflow-hidden border border-stone-200" 
             :class="{ 'hidden md:flex': activeView === 'editor' }" 
             x-data="{ tab: 'preview' }" x-show="isOutputVisible" x-cloak>
            <div class="flex justify-between items-center bg-stone-50 p-3 border-b border-stone-200 flex-shrink-0 flex-wrap gap-2">
                <div class="flex items-center space-x-2">
                    <button @click="activeView = 'editor'; $nextTick(() => { if(window.htmlEditor) window.htmlEditor.resize(); if(window.scriptEditor) scriptEditor.resize(); if(window.headEditor) headEditor.resize(); })" title="Back to Editor" class="md:hidden text-stone-500 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-stone-200 mr-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button @click="tab = 'preview'" :class="{ 'bg-indigo-100 text-indigo-700 font-semibold': tab === 'preview', 'text-stone-500 hover:bg-stone-200 hover:text-stone-700': tab !== 'preview' }" class="px-4 py-1.5 rounded-lg text-sm transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">Preview</button>
                    <button @click="tab = 'console'" :class="{ 'bg-indigo-100 text-indigo-700 font-semibold': tab === 'console', 'text-stone-500 hover:bg-stone-200 hover:text-stone-700': tab !== 'console' }" class="px-4 py-1.5 rounded-lg text-sm transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">Console</button>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    <button id="clear-console-button" @click="tab === 'console' && ($refs.consoleOutput.innerHTML = '')" class="text-stone-400 hover:text-indigo-600 text-sm font-medium flex items-center space-x-1.5 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400" title="Clear console">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        <span class="hidden sm:inline">Clear</span>
                    </button>
                    <button @click="isOutputVisible = false" title="Hide Output" class="text-stone-400 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-stone-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074L3.707 2.293zM10 12a2 2 0 110-4 2 2 0 010 4z" clip-rule="evenodd" />
                           <path d="M2 10C2 5.943 5.522 3 10 3a9.958 9.958 0 014.512 1.074l-1.473 1.473A3.987 3.987 0 0010 6a4 4 0 00-4 4 3.987 3.987 0 001.559 3.018L6.04 14.45A9.988 9.988 0 012 10z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow bg-white overflow-auto">
                <div x-show="tab === 'preview'" class="h-full bg-stone-100"><iframe id="preview-frame" class="w-full h-full border-0"></iframe></div>
                <div x-show="tab === 'console'" x-cloak class="h-full bg-slate-800 p-4 font-mono text-sm overflow-auto"><div id="console-output" x-ref="consoleOutput"></div></div>
            </div>
        </div>
    </div>
    
    <button x-show="activeView === 'editor'" @click="runCode(); activeView = 'output'" class="md:hidden fixed bottom-6 right-6 z-20 bg-indigo-500 hover:bg-indigo-600 text-white font-bold w-14 h-14 rounded-full flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
    </button>
    
    <footer class="text-center p-3 text-xs text-stone-400 flex-shrink-0">
        Web Editor with a Soft Touch
    </footer>

    <!-- NEW: Version History Panel -->
    <div x-show="isVersionsPanelOpen" 
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        @keydown.escape.prevent.stop="isVersionsPanelOpen = false"
        class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-start pt-16 md:pt-24"
        x-cloak>
        
        <div @click.outside="isVersionsPanelOpen = false"
            x-show="isVersionsPanelOpen"
            x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[70vh] flex flex-col border border-stone-200">
            
            <!-- Panel Header -->
            <div class="flex justify-between items-center p-4 border-b border-stone-200 flex-shrink-0">
                <h3 class="text-lg font-semibold text-stone-800">Code Version History</h3>
                <button @click="isVersionsPanelOpen = false" class="p-2 rounded-full text-stone-400 hover:bg-stone-200 hover:text-stone-600 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <!-- Panel Body (Version List) -->
            <div class="overflow-y-auto p-4 space-y-3">
                <template x-if="versions.length === 0">
                    <p class="text-stone-500 text-center py-8">No saved versions yet. Click "Save Current Version" to start tracking your changes.</p>
                </template>
                <template x-for="version in versions" :key="version.id">
                    <div class="flex justify-between items-center p-3 bg-stone-50 hover:bg-stone-100 rounded-lg transition-colors">
                        <span class="font-medium text-stone-700" x-text="`Saved on: ${formatDate(version.timestamp)}`"></span>
                        <div class="flex items-center space-x-2">
                            <button @click="restoreSelectedVersion(version.id)" class="px-3 py-1 text-sm font-semibold text-indigo-700 bg-indigo-100 hover:bg-indigo-200 rounded-md transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-indigo-400">Restore</button>
                            <button @click="deleteSelectedVersion(version.id)" class="p-2 text-stone-400 hover:text-red-500 rounded-full hover:bg-red-100 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-red-400" title="Delete this version">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Panel Footer -->
            <div class="p-4 border-t border-stone-200 flex-shrink-0">
                <button @click="saveCurrentVersion()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2.5 px-5 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200 shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                    <span>Save Current Version</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // MODIFIED: codeDB now supports a 'versions' store for history.
        const codeDB = {
            db: null,
            open() {
                return new Promise((resolve, reject) => {
                    // DB version is now 2 to trigger the upgrade process.
                    const request = indexedDB.open('CodeEditorDB', 2);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        // Keep the original 'code' store for the latest snapshot.
                        if (!this.db.objectStoreNames.contains('code')) {
                            this.db.createObjectStore('code', { keyPath: 'id' });
                        }
                        // If upgrading from a version without 'versions', create it.
                        if (event.oldVersion < 2) {
                            const versionsStore = this.db.createObjectStore('versions', { keyPath: 'id', autoIncrement: true });
                            versionsStore.createIndex('timestamp', 'timestamp');
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result; resolve();
                    };
                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error); reject(event.target.error);
                    };
                });
            },
            async saveCode(head, html, script) {
                if (!this.db) await this.open();
                const transaction = this.db.transaction(['code'], 'readwrite');
                const store = transaction.objectStore('code');
                store.put({ id: 'latest', head, html, script });
                return transaction.complete;
            },
            async loadCode() {
                if (!this.db) await this.open();
                const transaction = this.db.transaction(['code'], 'readonly');
                const store = transaction.objectStore('code');
                const request = store.get('latest');
                return new Promise((resolve) => {
                    request.onsuccess = () => { resolve(request.result); };
                    request.onerror = () => { resolve(null); };
                });
            },
            // NEW: Saves a version snapshot to the 'versions' store.
            async saveVersion(head, html, script) {
                if (!this.db) await this.open();
                const transaction = this.db.transaction(['versions'], 'readwrite');
                const store = transaction.objectStore('versions');
                store.add({ timestamp: new Date(), head, html, script });
                return transaction.complete;
            },
            // NEW: Retrieves all versions, sorted with newest first.
            async getVersions() {
                if (!this.db) await this.open();
                const transaction = this.db.transaction(['versions'], 'readonly');
                const store = transaction.objectStore('versions');
                const request = store.getAll();
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        // Reverse the array to show newest versions at the top.
                        resolve(request.result.reverse());
                    };
                    request.onerror = () => { reject(request.error); };
                });
            },
            // NEW: Gets a single version by its unique ID.
            async getVersionById(id) {
                if (!this.db) await this.open();
                const transaction = this.db.transaction(['versions'], 'readonly');
                const store = transaction.objectStore('versions');
                const request = store.get(id);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => { resolve(request.result); };
                    request.onerror = () => { reject(request.error); };
                });
            },
            // NEW: Deletes a version from the database.
            async deleteVersion(id) {
                if (!this.db) await this.open();
                const transaction = this.db.transaction(['versions'], 'readwrite');
                const store = transaction.objectStore('versions');
                store.delete(id);
                return transaction.complete;
            }
        };

        const previewFrame = document.getElementById('preview-frame');
        const consoleOutput = document.getElementById('console-output');

        function getFullSource() {
            const headCode = window.headEditor.getValue();
            const htmlCode = window.htmlEditor.getValue();
            const scriptCode = window.scriptEditor.getValue();
            return `<!DOCTYPE html>
<html lang="en">
<head>
${headCode}
</head>
<body class="bg-stone-100 antialiased">
    ${htmlCode}
    <script>
${scriptCode}
    <\/script>
</body>
</html>`;
        }
        
        window.runCode = () => {
            const headCode = window.headEditor.getValue();
            const htmlCode = window.htmlEditor.getValue();
            const scriptCode = window.scriptEditor.getValue();

            codeDB.saveCode(headCode, htmlCode, scriptCode).catch(err => console.error("Failed to save code:", err));
            
            consoleOutput.innerHTML = '';
            
            const source = `
                <!DOCTYPE html>
                <html>
                <head>
                    <script>
                        const customConsole = (originalLog) => (...args) => {
                            window.parent.postMessage({ source: 'iframe-console', type: originalLog.name, message: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg) }, '*');
                            originalLog.apply(console, args);
                        };
                        window.console.log = customConsole(window.console.log);
                        window.console.error = customConsole(window.console.error);
                        window.console.warn = customConsole(window.console.warn);
                        window.console.info = customConsole(window.console.info);
                        window.onerror = (message) => { window.parent.postMessage({ source: 'iframe-console', type: 'error', message: ['Uncaught Error: ' + message] }, '*'); };
                    <\/script>
                    ${headCode}
                </head>
                <body class="bg-stone-100 antialiased">
                    ${htmlCode}
                    <script>
                        try { ${scriptCode} } catch (e) { console.error(e.message); }
                    <\/script>
                </body>
                </html>`;

            previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(source);
        };
        
        window.exportToFile = () => {
            const source = getFullSource();
            const blob = new Blob([source], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-creation.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        function parseAndLoadHtml(contents) {
            if (!contents || typeof contents !== 'string') {
                alert('No content provided to import.');
                return false;
            }
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(contents, 'text/html');
                
                const headContent = doc.head.innerHTML.trim();
                
                const bodyClone = doc.body.cloneNode(true);
                const inlineScripts = Array.from(bodyClone.querySelectorAll('script:not([src])'));
                const scriptContents = [];

                inlineScripts.forEach(script => {
                    scriptContents.push(script.textContent);
                    script.remove();
                });

                const htmlContent = bodyClone.innerHTML.trim();
                const combinedScriptContent = scriptContents.join('\n\n/* --- SCRIPT SEPARATOR --- */\n\n');

                window.headEditor.setValue(headContent, 1);
                window.htmlEditor.setValue(htmlContent, 1);
                window.scriptEditor.setValue(combinedScriptContent, 1);
                
                runCode();
                return true;
            } catch (e) {
                console.error("Failed to parse imported HTML:", e);
                alert("The content could not be parsed as valid HTML.");
                return false;
            }
        }
        
        window.importFromFile = (event) => {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                parseAndLoadHtml(e.target.result);
            };
            reader.readAsText(file);
            event.target.value = null; 
        };

        async function initializeEditor() {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace/theme/chrome");
                editor.session.setMode(`ace/mode/${mode}`);
                editor.setOptions({
                    fontSize: "15px",
                    fontFamily: "Fira Code, monospace",
                    enableBasicAutocompletion: true,
                    enableLiveAutocompletion: true,
                    highlightActiveLine: false,
                    showGutter: true,
                    showPrintMargin: false,
                    useWorker: false 
                });
                return editor;
            }

            window.headEditor = createEditor('head-editor', 'html');
            window.htmlEditor = createEditor('html-editor', 'html');
            window.scriptEditor = createEditor('script-editor', 'javascript');

            const savedCode = await codeDB.loadCode();
            
            if (savedCode && savedCode.html) {
                window.headEditor.setValue(savedCode.head || '', 1);
                window.htmlEditor.setValue(savedCode.html, 1);
                window.scriptEditor.setValue(savedCode.script, 1);
            } else {
                const initialHead =
`<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soft UI To-Do App</title>
<script src="https://cdn.tailwindcss.com"><\/script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"><\/script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { 
        font-family: 'Inter', sans-serif;
        background-color: #f5f5f4;
    }
<\/style>`;
                
                const initialHtml =
`<div class="p-8 max-w-2xl mx-auto my-10 bg-white rounded-2xl shadow-lg" x-data="{
    todos: [
      { text: 'Learn Alpine.js', completed: true },
      { text: 'Build a beautiful project', completed: false },
      { text: 'Deploy to production', completed: false }
    ],
    newTodo: ''
}">
    <h1 class="text-3xl font-bold text-stone-800">My Tasks</h1>
    <p class="mt-1 text-stone-500">A simple and soft to-do list.</p>
    
    <form @submit.prevent="if (newTodo.trim()) { todos.push({ text: newTodo.trim(), completed: false }); newTodo = '' }" class="mt-6 flex">
        <input type="text" x-model="newTodo" placeholder="What needs to be done?" class="border border-stone-200 rounded-l-lg px-4 py-2 w-full focus:ring-2 focus:ring-indigo-300 focus:outline-none transition">
        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-5 py-2 rounded-r-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400">Add</button>
    </form>

    <ul class="mt-6 space-y-3">
        <template x-for="(todo, index) in todos" :key="index">
            <li @click="todo.completed = !todo.completed" 
                class="bg-stone-50 p-4 rounded-lg flex items-center cursor-pointer hover:bg-stone-100 transition group">
                <div class="w-6 h-6 mr-4 flex-shrink-0 rounded-full border-2 flex items-center justify-center"
                     :class="todo.completed ? 'border-indigo-400 bg-indigo-400' : 'border-stone-300'">
                     <svg x-show="todo.completed" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                     </svg>
                </div>
                <span :class="{ 'line-through text-stone-400': todo.completed, 'text-stone-700': !todo.completed }" x-text="todo.text"></span>
            </li>
        </template>
    </ul>

    <p class="mt-6 text-sm text-stone-500 text-center">
        You have <span class="font-bold" x-text="todos.filter(t => !t.completed).length"></span> tasks left.
    </p>
</div>`;
                const initialScript = 
`console.log("Soft UI To-Do App Initialized!");
console.warn("Try clicking a task to mark it complete.");
console.error("This is how an error message looks in the console.");
console.log({ detail: "Objects are logged nicely too.", value: 42 });`;
                
                window.headEditor.setValue(initialHead, 1);
                window.htmlEditor.setValue(initialHtml, 1);
                window.scriptEditor.setValue(initialScript, 1);
            }
            
            window.runCode();
        }

        window.addEventListener('message', (event) => {
            if (event.data && event.data.source === 'iframe-console') {
                const logEntry = document.createElement('div');
                const messages = event.data.message.join(' ');
                let textColor = 'text-stone-300';
                let typePrefix = 'LOG';
                let typeColor = 'text-stone-400';
                if (event.data.type === 'error') {
                    textColor = 'text-red-400';
                    typePrefix = 'ERR';
                    typeColor = 'text-red-500'
                } else if (event.data.type === 'warn') {
                    textColor = 'text-yellow-400';
                    typePrefix = 'WARN';
                    typeColor = 'text-yellow-500';
                }
                logEntry.className = `flex items-start border-b border-slate-700 py-2 px-1 ${textColor}`;
                logEntry.innerHTML = `<span class="w-12 flex-shrink-0 mr-4 font-semibold ${typeColor}">[${typePrefix}]</span><pre class="whitespace-pre-wrap break-all">${messages}</pre>`;
                consoleOutput.appendChild(logEntry);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        });

        setTimeout(initializeEditor, 100);
    </script>
</body>
</html>
